---
title: "Homofilia absoluta 2014-2019"
author: "redeslab.gitlab.io "
date: "Septiembre, 2021"
output: 
   rmarkdown::html_document:
     theme: lumen
     toc: true 
     toc_depth: 2  
     number_sections: true
     toc_float: true
     toc_collapsed: true
     highlight: pygments
---

# Cargamos Librerías
```{r,message=FALSE,warning=FALSE}
library(tidyverse)
library(naniar)
library(car)
library(JWileymisc)
library(data.table)
library(questionr)
library(tigerstats)
library(readxl)
library(memisc)
library(kableExtra)
library(boot)

```

# ENACOES 2014 
```{r,warning=FALSE, message=FALSE}
load("C:/Users/rober/Downloads/ENACOES_2014_V5.RData")
coes<-enacoes
```

## Recodifcamos variables 

### Sexo
```{r}
coes = coes[sort.list(coes$FOLIO),]
#names(coes)

coes$ego_sexo = as.numeric(coes$P1==1)
#table(coes$ego_sexo)
```

### Edad (continua)
```{r}
coes$ego_edad = coes$P2
#summary(coes$ego_edad)
#coes$ego_edad <- recode(coes$edad,"18:24=1; 25:34=2; 35:44=3; 45:54=4; 55:64=5; 65:75=6")
```

### Educación 
```{r}
coes$ego_educ = coes$P4
#coes$educa[coes$P4==1] = 2       #Juntar sin estudios con básica incompleta
#coes$educa[coes$P4==10] = 9      #Juntar Uni completa + posgrado
#coes$educa[coes$P4>=88] = NA

#Educacion categorica
coes$ego_educ[coes$ego_educ=="88"] <- NA
coes$ego_educ[coes$ego_educ=="99"] <- NA
coes$ego_educ[coes$ego_educ<=3] = 1                     # - que básica
coes$ego_educ[coes$ego_educ>=4 & coes$ego_educ<=5] = 2  # Secundaria
coes$ego_educ[coes$ego_educ>=6 & coes$ego_educ<=7] = 3  # Técnica
coes$ego_educ[coes$ego_educ>=8 & coes$ego_educ<=10] = 4 # Universitaria

coes$ego_educ<-as.factor(coes$ego_educ)
table(coes$ego_educ)
prop.table(table(coes$ego_educ))
```

### Educación madre
```{r}
#coes$S17
```

### Educación padre
```{r}
#coes$S18
```



### Religión
```{r}
coes$S24[coes$S24=="88"] <- NA
coes$S24[coes$S24=="99"] <- NA
coes$ego_relig = as.numeric(coes$S24) 
table(coes$ego_relig)
coes$ego_relig[coes$ego_relig==1] = 1                  #Catolico
coes$ego_relig[coes$ego_relig==2] = 2                  #Evangélico
coes$ego_relig[coes$ego_relig>=3 & coes$S24<=8] = 3    #Otra relig
coes$ego_relig[coes$ego_relig>=9 & coes$S24<=11] = 4   #Ninguna+Ate+Agnostico+Ns
#coes$ego_relig = factor(coes$religid, labels=c("Catolico", "Evangelico",
#                                             "Otra Religion", "Irreligioso"))
prop.table(table(coes$ego_relig))
```

### Barrio
```{r}
coes$ego_barrio<-1

#Estado Civil
#coes$estcivil = coes$P5
#coes$estcivil[coes$P5==9] = NA
#coes$estcivil[coes$P5==6] = 5
#coes$estcivil[coes$P5==7] = 5
#coes$estcivil = factor(coes$estcivil, labels=c("Casado","Conviviente","Soltero/a",
#                                               "Viudo/a","Sepa/Divor/Anu"))
```

### Grupo étnico
```{r}
coes$etmino = as.numeric(coes$S1<=9)
table(coes$etmino)
```

### Ego ideol
```{r}
table(coes$F6) #ideol

coes$F6[coes$F6 == 1 | coes$F6 == 2 ] <- 'leftwinger' 
coes$F6[coes$F6 == 3 | coes$F6 == 4 ] <- 'center-left' 
coes$F6[coes$F6 == 5 | coes$F6 == 6 ] <- 'center'
coes$F6[coes$F6 == 7 | coes$F6 == 8 ] <- 'center-riht'
coes$F6[coes$F6 == 9 | coes$F6 == 10] <- 'rightwinger'

coes$ego_ideol<-coes$F6
coes$ego_ideol[coes$ego_ideol==99] <- "none"
coes$ego_ideol[coes$ego_ideol==88] <- "none"
table(coes$ego_ideol)
```


### Grado
```{r}
coes$tamred = as.numeric(coes$A10_A1!="") + as.numeric(coes$A10_A2!="") + 
  as.numeric(coes$A10_A3!="") + as.numeric(coes$A10_A4!="") + 
  as.numeric(coes$A10_A5!="")
table(coes$tamred)
print(prop.table(table(coes$tamred)), 2)
```

### Alter sexo
```{r}
coes$alter_sexo1 = as.numeric(coes$A10_B1==1)
coes$alter_sexo2 = as.numeric(coes$A10_B2==1)
coes$alter_sexo3 = as.numeric(coes$A10_B3==1)
coes$alter_sexo4 = as.numeric(coes$A10_B4==1)
coes$alter_sexo5 = as.numeric(coes$A10_B5==1)
prop.table(table(coes$alter_sexo1[coes$tamred>=1], exclude=NULL))
prop.table(table(coes$alter_sexo1[coes$tamred>=4], exclude=NULL))
```

### Alter edad
```{r}
coes$alter_edad1<-coes$A10_C1
coes$alter_edad1[coes$A10_C1=="99"] <- NA
coes$alter_edad2<-coes$A10_C2
coes$alter_edad2[coes$A10_C2=="99"] <- NA
coes$alter_edad3<-coes$A10_C3
coes$alter_edad3[coes$A10_C3=="99"] <- NA
coes$alter_edad4<-coes$A10_C4
coes$alter_edad4[coes$A10_C4=="99"] <- NA
coes$alter_edad5<-coes$A10_C5
coes$alter_edad5[coes$A10_C5=="99"] <- NA
```

### Alter religión
```{r}
coes$alter_relig1 = recode(coes$A10_G1, "1=1; 2=2; 3=3; 4:6=4; 8:9=NA")
coes$alter_relig2 = recode(coes$A10_G2, "1=1; 2=2; 3=3; 4:6=4; 8:9=NA")
coes$alter_relig3 = recode(coes$A10_G3, "1=1; 2=2; 3=3; 4:6=4; 8:9=NA")
coes$alter_relig4 = recode(coes$A10_G4, "1=1; 2=2; 3=3; 4:6=4; 8:9=NA")
coes$alter_relig5 = recode(coes$A10_G5, "1=1; 2=2; 3=3; 4:6=4; 8:9=NA")
str(coes$alter_relig1)
prop.table(table(coes$alter_relig1[coes$tamred>=1], exclude=NULL))
prop.table(table(coes$alter_relig3[coes$tamred>=3], exclude=NULL))
```

### Alter educación 
```{r}
coes$alter_educ1 = recode(coes$A10_H1,"1:3=1; 4:5=2; 6:7=3; 8:10=4; 99=NA")
coes$alter_educ2 = recode(coes$A10_H2,"1:3=1; 4:5=2; 6:7=3; 8:10=4; 99=NA")
coes$alter_educ3 = recode(coes$A10_H3,"1:3=1; 4:5=2; 6:7=3; 8:10=4; 99=NA")
coes$alter_educ4 = recode(coes$A10_H4,"1:3=1; 4:5=2; 6:7=3; 8:10=4; 99=NA")
coes$alter_educ5 = recode(coes$A10_H5,"1:3=1; 4:5=2; 6:7=3; 8:10=4; 99=NA")
str(coes$alter_educ1)
prop.table(table(coes$alter_educ1[coes$tamred>=1], exclude=NULL))
prop.table(table(coes$alter_educ3[coes$tamred>=3], exclude=NULL))
```

### Alter barrio
```{r}
coes<-coes%>%
dplyr::mutate(alter_barrio1=ifelse(A10_D1==5,1,0)) %>%
dplyr::mutate(alter_barrio2=ifelse(A10_D2==5,1,0)) %>%
dplyr::mutate(alter_barrio3=ifelse(A10_D3==5,1,0)) %>%
dplyr::mutate(alter_barrio4=ifelse(A10_D4==5,1,0)) %>%
dplyr::mutate(alter_barrio5=ifelse(A10_D5==5,1,0))

coes$alter_barrio1[coes$A10_D1==99] = NA
coes$alter_barrio2[coes$A10_D2==99] = NA
coes$alter_barrio3[coes$A10_D3==99] = NA
coes$alter_barrio4[coes$A10_D4==99] = NA
coes$alter_barrio5[coes$A10_D5==99] = NA

# crear variable proporción del total de vecinos
coes<-coes %>% 
  rowwise() %>% 
  mutate(barrio_total = sum(alter_barrio1,alter_barrio2,alter_barrio3,
                   alter_barrio4,alter_barrio5, na.rm=TRUE))%>%
  mutate(barrio_prop = barrio_total/tamred)

mean(coes$barrio_prop, na.rm=TRUE)
#[1] 0.0892339

#table(coes$alter_barrio1)
#Guardar base de datos
#save(coes, file = "coesHomofilia.Rdata")
```

### Alter ideología 
```{r}
## ideol alter, derecha, centro derecha, centro, centro izquierda, izquierda, ninguno (6)
table(coes$A10_I1) #

for (i in 1:5){
  eval(parse(text=paste('coes$A10_I',i,'[coes$A10_I',i,'==1 & !is.na(coes$A10_I',i,')]<-\'rightwinger\' ;',
                        'coes$A10_I',i,'[coes$A10_I',i,'==2 & !is.na(coes$A10_I',i,')]<-\'center-right\' ;',
                        'coes$A10_I',i,'[coes$A10_I',i,'==3 & !is.na(coes$A10_I',i,')]<-\'center\' ;',
                        'coes$A10_I',i,'[coes$A10_I',i,'==4 & !is.na(coes$A10_I',i,')]<-\'center-left\' ;',
                        'coes$A10_I',i,'[coes$A10_I',i,'==5 & !is.na(coes$A10_I',i,')]<-\'leftwinger\'; ',
                        'coes$A10_I',i,'[coes$A10_I',i,'==8 & !is.na(coes$A10_I',i,')]<-\'none\'; ',
                        'coes$A10_I',i,'[coes$A10_I',i,'==9 & !is.na(coes$A10_I',i,')]<-\'none\' ', sep='')))
}

coes$alter_ideol1<-coes$A10_I1
table(coes$alter_ideol1)

coes$alter_ideol2<-coes$A10_I2
table(coes$alter_ideol2)                                    

coes$alter_ideol3<-coes$A10_I3
table(coes$alter_ideol3)

coes$alter_ideol4<-coes$A10_I4
table(coes$alter_ideol4)

coes$alter_ideol5<-coes$A10_I5
table(coes$alter_ideol5)
```

### Alter relación
```{r}
coes$alter_relacion1<-coes$A10_D1
coes$alter_relacion1[coes$A10_D1==99] = NA
coes$alter_relacion2<-coes$A10_D2
coes$alter_relacion2[coes$A10_D2==99] = NA
coes$alter_relacion3<-coes$A10_D3
coes$alter_relacion3[coes$A10_D3==99] = NA
coes$alter_relacion4<-coes$A10_D4
coes$alter_relacion4[coes$A10_D4==99] = NA
coes$alter_relacion5<-coes$A10_D5
coes$alter_relacion5[coes$A10_D5==99] = NA
table(coes$alter_relacion1)

for (i in 1:5){
  eval(parse(text=paste('coes$alter_relacion',i,'[coes$alter_relacion',i,'==1  & !is.na(coes$alter_relacion',i,')]<-\'fam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==2  & !is.na(coes$alter_relacion',i,')]<-\'fam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==3  & !is.na(coes$alter_relacion',i,')]<-\'fam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==4  & !is.na(coes$alter_relacion',i,')]<-\'fam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==5  & !is.na(coes$alter_relacion',i,')]<-\'fam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==6  & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==7  & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==8  & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==9  & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==10 & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ;',
                        'coes$alter_relacion',i,'[coes$alter_relacion',i,'==11 & !is.na(coes$alter_relacion',i,')]<-\'nofam\' ',sep='')))
}
```

## Select data ENACOES
```{r}
coes1<-coes%>%
  dplyr::select(idencuesta=FOLIO,ego_sexo,ego_edad,ego_educ,ego_relig,ego_barrio,
                ego_ideol,tamred,alter_sexo1,alter_sexo2,alter_sexo3,alter_sexo4,
                alter_sexo5,alter_edad1,alter_edad2,alter_edad3,alter_edad4,
                alter_edad5,alter_relig1,alter_relig2,alter_relig3,alter_relig4,
                alter_relig5,alter_educ1,alter_educ2,alter_educ3,alter_educ4,
                alter_educ5,alter_barrio1,alter_barrio2,alter_barrio3,
                alter_barrio4,alter_barrio5, alter_ideol1, alter_ideol2,
                alter_ideol3, alter_ideol4, alter_ideol5, alter_relacion1,
                alter_relacion2, alter_relacion3, alter_relacion4, alter_relacion5,
                ponderador=POND_MUESTRAL)

homoC_2014<-coes1
homoC_2014$ego_m_educ<-NA
homoC_2014$ego_p_educ<-NA
homoC_2014$machismo<-NA
homoC_2014$cal_entorno<-NA

homoC_2014<-homoC_2014%>%
  dplyr::select(idencuesta,ego_sexo, ego_edad, ego_educ, ego_relig, ego_barrio,
                ego_ideol,tamred,alter_sexo1, alter_sexo2, alter_sexo3, alter_sexo4,
                alter_sexo5, alter_edad1, alter_edad2, alter_edad3, alter_edad4,
                alter_edad5, alter_relig1, alter_relig2, alter_relig3, alter_relig4,
                alter_relig5, alter_educ1, alter_educ2, alter_educ3, alter_educ4,
                alter_educ5, alter_barrio1, alter_barrio2, alter_barrio3, alter_barrio4,
                alter_barrio5, alter_ideol1, alter_ideol2, alter_ideol3, alter_ideol4,
                alter_ideol5, alter_relacion1,alter_relacion2,alter_relacion3, 
                alter_relacion4, alter_relacion5,ponderador,
                ego_p_educ, ego_m_educ, machismo, cal_entorno)

homoC_2014$año<-2014
```

## Distancia observada
```{r}
##NOTA: weights are problematic: seleccionan misma persona con mucha mayor frecuencia.
d <- length(coes1$idencuesta)
table(table(sample(coes1$idencuesta, d, replace=T, prob = (1/coes1$ponderador))))
table(table(sample(coes1$idencuesta, d, replace=T)))
#Si se usa ponderador, usar de la ola 1, no 2 (este tiene NA's)

#Distancia Social Observada entre Ego-Alter
vars_to_keep <- c("idencuesta", "ego_educ", "ego_relig",
                  "ego_ideol", "ego_edad", "ego_sexo", "ego_barrio",
                  "alter_educ1", "alter_educ2", "alter_educ3",
                  "alter_educ4", "alter_educ5", "alter_relig1",
                  "alter_relig2", "alter_relig3", "alter_relig4",
                  "alter_relig5", "alter_ideol1", "alter_ideol2", 
                  "alter_ideol3", "alter_ideol4", "alter_ideol5",
                  "alter_edad1", "alter_edad2", "alter_edad3",
                  "alter_edad4", "alter_edad5", "alter_sexo1", 
                  "alter_sexo2", "alter_sexo3", "alter_sexo4", 
                  "alter_sexo5","alter_barrio1","alter_barrio2",
                  "alter_barrio3","alter_barrio4","alter_barrio5")

enacoes_egos <- coes1[names(coes1) %in% vars_to_keep]

educa_obs_dist <- array(NA, dim=list(nrow(enacoes_egos), 5))
edad_obs_dist  <- array(NA, dim=list(nrow(enacoes_egos), 5))
relig_obs_dist <- array(NA, dim=list(nrow(enacoes_egos), 5))
sexo_obs_dist  <- array(NA, dim=list(nrow(enacoes_egos), 5))
barrio_obs_dist<- array(NA, dim=list(nrow(enacoes_egos), 5))
ideol_obs_dist <- array(NA, dim=list(nrow(enacoes_egos), 5))

### Distancia ego-alter observados

## Educación
for(k in 1:5) educa_obs_dist[,k] <- ifelse(
  coes1$ego_educ == eval(parse(text=paste0("coes1$alter_educ", k))), 1, 0)
educa_obs_dist <- data.frame(educa_obs_dist)
names(educa_obs_dist) <- paste0("educ_dist_",1:5)

## Edad
for(k in 1:5) edad_obs_dist[,k] <- ifelse(
  ((coes1$ego_edad) - eval(parse(text=paste0("coes1$alter_edad", k))))<=5, 1, 0)
edad_obs_dist <- data.frame(edad_obs_dist)
names(edad_obs_dist) <- paste0("edad_dist_",1:5)

## Religion
for(k in 1:5) relig_obs_dist[,k] <- ifelse(
  coes1$ego_relig == eval(parse(text=paste0("coes1$alter_relig", k))), 1, 0)
relig_obs_dist <- data.frame(relig_obs_dist)
names(relig_obs_dist) <- paste0("relig_dist_",1:5)

## Sexo
for(k in 1:5) sexo_obs_dist[,k] <- ifelse(
  coes1$ego_sexo == eval(parse(text=paste0("coes1$alter_sexo", k))), 1, 0)
sexo_obs_dist <- data.frame(sexo_obs_dist)
names(sexo_obs_dist) <- paste0("sexo_dist_",1:5)

## Barrio
for(k in 1:5) barrio_obs_dist[,k] <- ifelse(
  coes1$ego_barrio == eval(parse(text=paste0("coes1$alter_barrio", k))), 1, 0)
barrio_obs_dist <- data.frame(barrio_obs_dist)
names(barrio_obs_dist) <- paste0("barrio_dist_",1:5)

## Ideología
for(k in 1:5) ideol_obs_dist[,k] <- ifelse(
  coes1$ego_ideol == eval(parse(text=paste0("coes1$alter_ideol", k))), 1, 0)
ideol_obs_dist <- data.frame(ideol_obs_dist)
names(ideol_obs_dist) <- paste0("ideol_dist_",1:5)

hom_obs <- data.frame(cbind(enacoes_egos, educa_obs_dist, edad_obs_dist, 
                            relig_obs_dist, sexo_obs_dist, barrio_obs_dist,
                            ideol_obs_dist))
hom_obs$case <- 1
```

```{r}
hom_obs<-hom_obs%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4, 
                barrio_dist_5, ideol_dist_1, ideol_dist_2, ideol_dist_3, 
                ideol_dist_4, ideol_dist_5)

head(hom_obs)
```

## Simulación (controles)
```{r}
## Preparativos simulacion de alteres
sexo_sim_dist  <- array(NA, dim=list(nrow(enacoes_egos), 5))
edad_sim_dist  <- array(NA, dim=list(nrow(enacoes_egos), 5))
educ_sim_dist  <- array(NA, dim=list(nrow(enacoes_egos), 5))
relig_sim_dist <- array(NA, dim=list(nrow(enacoes_egos), 5))
barrio_sim_dist<- array(NA, dim=list(nrow(enacoes_egos), 5))
ideol_sim_dist <- array(NA, dim=list(nrow(enacoes_egos), 5))

```

### Weight en base a CASEN
```{r}
w_casen <- read.csv("C:/Users/rober/Desktop/homofilia_elsoc/weight_casen.csv", sep=";")
```

### Simulación con parámetros
```{r}
set.seed(44322)
n <- 50
d <- length(enacoes_egos$idencuesta)
```

### Post-stratificaction weight
```{r}
age_recode <- "18:30=18; 31:45=31; 46:60=46; else=61"
enacoes_egos$age_grp <- car::recode(enacoes_egos$ego_edad, age_recode)
enacoes_egos$educ_grp <- enacoes_egos$ego_educ
educ_recode <- "1=2;2=3;3=4;else=5"
enacoes_egos$educ_grp <- car::recode(enacoes_egos$ego_educ, educ_recode)
enacoes_egos$educ_grp <- factor(enacoes_egos$educ_grp, exclude=NULL)

w <- data.frame(xtabs(~educ_grp + ego_sexo + age_grp, data=enacoes_egos))
#names(w) <- c("educaR_w02", "m0_sexo_w02", "Freq")
w$prop <- w$Freq / sum(w$Freq)
w$prop_target <- w_casen[,4]
w$N_target <- w$prop_target*sum(w$Freq)
w$w <- w$N_target/w$Freq
w$ego_sexo <- as.numeric(levels(w$ego_sexo))[w$ego_sexo]

el <- merge(enacoes_egos, w, by=c("educ_grp", "ego_sexo", "age_grp"))
```

### Muetsrar alteris aleatorios desde egos observados
```{r}
#NOTA: Usar 'join' en lugar de 'merge', ya que este ultimo ordena las filas segun
#'idencuesta', y por ende altera la seleccion aleatoria de alteres.
nonties1 <- data.frame(idencuesta = sample(el$idencuesta, d, replace=T, el$w))
nonties1 <- plyr::join(nonties1, enacoes_egos, by="idencuesta")

nonties2 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties2 <- plyr::join(nonties2, enacoes_egos, by="idencuesta")

nonties3 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties3 <- plyr::join(nonties3, enacoes_egos, by="idencuesta")

nonties4 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties4 <- plyr::join(nonties4, enacoes_egos, by="idencuesta")

nonties5 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties5 <- plyr::join(nonties5, enacoes_egos, by="idencuesta")

  #Delete variables for next loop
    enacoes_egos$Freq <- NULL
    enacoes_egos$prop <- NULL
    enacoes_egos$prop_target <- NULL
    enacoes_egos$N_target <- NULL
    enacoes_egos$w <- NULL
    enacoes_egos$age_grp <- NULL
    enacoes_egos$educ_grp <- NULL
    
### Distancia ego-alter simuladaos
    
## Educ
for(k in 1:5) educ_sim_dist[,k] <- ifelse(
    coes1$ego_educ == eval(parse(text=paste0("nonties",k,"$ego_educ"))), 1, 0)
    educ_sim_dist <- data.frame(educ_sim_dist)
    names(educ_sim_dist) <- paste0("educ_dist_",1:5)
    
## Edad
for(k in 1:5) edad_sim_dist[,k] <- ifelse(
    ((coes1$ego_edad) - eval(parse(text=paste0("nonties",k,"$ego_edad"))))<=5, 1, 0)
    edad_sim_dist <- data.frame(edad_sim_dist)
    names(edad_sim_dist) <- paste0("edad_dist_",1:5)
    
## Religion
for(k in 1:5) relig_sim_dist[,k] <- ifelse(
    coes1$ego_relig == eval(parse(text=paste0("nonties",k,"$ego_relig"))), 1, 0)
    relig_sim_dist <- data.frame(relig_sim_dist)
    names(relig_sim_dist) <- paste0("relig_dist_",1:5)
    
## Sexo
for(k in 1:5) sexo_sim_dist[,k] <- ifelse(
    coes1$ego_sexo == eval(parse(text=paste0("nonties",k,"$ego_sexo"))), 1, 0)
    sexo_sim_dist <- data.frame(sexo_sim_dist)
    names(sexo_sim_dist) <- paste0("sexo_dist_",1:5)
    
## Barrio
#for(k in 1:5) barrio_sim_dist[,k] <- ifelse(
#  coes$ego_barrio == eval(parse(text=paste0("nonties",k,"$alter_barrio"))), 1, 0)

#barrio_sim_dist<-apply(barrio_sim_dist, c(1,2), function(x) sample(c(0,1),1))
barrio_sim_dist <- matrix(rbinom(2025*5,1,0.09),2025,5) # Criterio minimalista 
barrio_sim_dist <- data.frame(barrio_sim_dist)
names(barrio_sim_dist) <- paste0("barrio_dist_",1:5)

## ideología
for(k in 1:5) ideol_sim_dist[,k] <- ifelse(
    coes1$ego_ideol == eval(parse(text=paste0("nonties",k,"$ego_ideol"))), 1, 0)
    ideol_sim_dist <- data.frame(ideol_sim_dist)
    names(ideol_sim_dist) <- paste0("ideol_dist_",1:5)
    
hom_sim <- data.frame(cbind(el, educ_sim_dist, edad_sim_dist, relig_sim_dist, 
                            sexo_sim_dist, barrio_sim_dist, ideol_sim_dist))
hom_sim$case <- 0
```

```{r}
hom_sim<-hom_sim%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4, 
                barrio_dist_5, ideol_dist_1,ideol_dist_2,ideol_dist_3,
                ideol_dist_4,ideol_dist_5)

head(hom_sim)
```

### Eliminar alteres simulados si info de alter no fue observada
```{r}
vwm <- names(hom_sim)[!names(hom_sim) %in% c("idencuesta","case")]
for(l in 1:length(vwm)) hom_sim[vwm[l]][is.na(hom_obs[vwm[l]])]<- NA
head(hom_sim)
```

### Merge & reshape 
```{r}
#Merge
homo<-plyr::rbind.fill(hom_obs, hom_sim)

#Reshape Data 
homoL<-reshape(homo,varying=list(paste0("educ_dist_", 1:5),
                                 paste0("edad_dist_", 1:5),
                                 paste0("relig_dist_", 1:5),
                                 paste0("sexo_dist_", 1:5),
                                 paste0("barrio_dist_", 1:5),
                                 paste0("ideol_dist_", 1:5)),
                 v.names=c("educ_dist", "edad_dist", "relig_dist", "sexo_dist",
                           "barrio_dist", "ideol_dist"), 
                 direction="long")

homoL<-arrange(homoL, idencuesta)
rownames(homoL)<-NULL

homoL_2014<-homoL[order(homoL$idencuesta),]
homoL_2014$año<-2014
#Drop lots of NA's - though with or without N of regresion is equal.
#homoL <- subset(homoL, !is.na(sexo_dist))
#head(homoL, 20)
```

# Descriptivos 

## Sexo distancia (observada y simulada)
```{r}

meanFunc <- function(x,i){mean(x[i])}

sexo_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

sexo_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

boot_sexo_o<-boot(sexo_dist_b_o$sexo_dist, meanFunc, 1000)
boot_sexo_o
mean<-0.62
SE<-0.007
dist_obs_sexo_des<-c(mean,SE)
dist_obs_sexo_des

boot_sexo_s<-boot(sexo_dist_b_s$sexo_dist, meanFunc, 1000)
boot_sexo_s
mean<-0.5
SE<-0.006
dist_sim_sexo_des<-c(mean,SE)
dist_sim_sexo_des

dist_sexo_abs_2014<-rbind(dist_obs_sexo_des,dist_sim_sexo_des)
dist_sexo_abs_2014
```


## edad (observada y simulada)
```{r}
edad_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

edad_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

boot_edad_o<-boot(edad_dist_b_o$edad_dist, meanFunc, 1000)
boot_edad_o
mean<-0.68
SE<-0.006
dist_obs_edad_des<-c(mean,SE)
dist_obs_edad_des

boot_edad_s<-boot(edad_dist_b_s$edad_dist, meanFunc, 1000)
boot_edad_s
mean<-0.50
SE<-0.007
dist_sim_edad_des<-c(mean,SE)
dist_sim_edad_des

dist_edad_abs_2014<-rbind(dist_obs_edad_des,dist_sim_edad_des)
dist_edad_abs_2014
```


## educ (observada y simulada)
```{r}
educ_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

educ_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

boot_educ_o<-boot(educ_dist_b_o$educ_dist, meanFunc, 1000)
boot_educ_o
mean<-0.50
SE<-0.007
dist_obs_educ_des<-c(mean,SE)
dist_obs_educ_des

boot_educ_s<-boot(educ_dist_b_s$educ_dist, meanFunc, 1000)
boot_educ_s
mean<-0.26
SE<-0.006
dist_sim_educ_des<-c(mean,SE)
dist_sim_educ_des

dist_educ_abs_2014<-rbind(dist_obs_educ_des,dist_sim_educ_des)
dist_educ_abs_2014
```

## relig (observada y simulada)
```{r}
relig_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

relig_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

boot_relig_o<-boot(relig_dist_b_o$relig_dist, meanFunc, 1000)
boot_relig_o
mean<-0.71
SE<-0.006
dist_obs_relig_des<-c(mean,SE)
dist_obs_relig_des

boot_relig_s<-boot(relig_dist_b_s$relig_dist, meanFunc, 1000)
boot_relig_s
mean<-0.46
SE<-0.007
dist_sim_relig_des<-c(mean,SE)
dist_sim_relig_des

dist_relig_abs_2014<-rbind(dist_obs_relig_des,dist_sim_relig_des)
dist_relig_abs_2014
```

## barrio (observada y simulada)
```{r}
barrio_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

barrio_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

boot_barrio_o<-boot(barrio_dist_b_o$barrio_dist, meanFunc, 1000)
boot_barrio_o
mean<-0.00
SE<-0.000
dist_obs_barrio_des<-c(mean,SE)
dist_obs_barrio_des

boot_barrio_s<-boot(barrio_dist_b_s$barrio_dist, meanFunc, 1000)
boot_barrio_s
mean<-0.000
SE<-0.000
dist_sim_barrio_des<-c(mean,SE)
dist_sim_barrio_des

dist_barrio_abs_2014<-rbind(dist_obs_barrio_des,dist_sim_barrio_des)
dist_barrio_abs_2014
```


## ideología (observada y simulada)
```{r}
ideol_dist_b_s<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

ideol_dist_b_o<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

boot_ideol_o<-boot(ideol_dist_b_o$ideol_dist, meanFunc, 1000)
boot_ideol_o
mean<-0.37
SE<-0.006
dist_obs_ideol_des<-c(mean,SE)
dist_obs_ideol_des

boot_ideol_s<-boot(ideol_dist_b_s$ideol_dist, meanFunc, 1000)
boot_ideol_s
mean<-0.25
SE<-0.005
dist_sim_ideol_des<-c(mean,SE)
dist_sim_ideol_des

dist_ideol_abs_2014<-rbind(dist_obs_ideol_des,dist_sim_ideol_des)
dist_ideol_abs_2014
```


```{r}
hom_abs_2014<-rbind(  dist_sexo_abs_2014,
                      dist_educ_abs_2014,
                      dist_edad_abs_2014,
                     dist_relig_abs_2014,
                     dist_ideol_abs_2014,
                    dist_barrio_abs_2014)

hom_abs_2014<-as.data.frame(hom_abs_2014)
colnames(hom_abs_2014)<-c("Mean", "SE")
rownames(hom_abs_2014)<-c("Distancia observada por sexo",
                          "Distancia esperada por chance por sexo",
                          "Distancia observada por educación",
                          "Distancia esperada por chance por educación",
                          "Distancia observada por edad",
                          "Distancia esperada por chance por edad",
                          "Distancia observada por religión",
                          "Distancia esperada por chance por religión",
                          "Distancia observada por ideología",
                          "Distancia esperada por chance por ideología",
                          "Distancia observada por barrio",
                          "Distancia esperada por chance por barrio")
```


## Test por grupo caso/control
```{r,results='asis',message=FALSE}
hom_2014<-egltable(c("sexo_dist", "edad_dist", "educ_dist", "relig_dist",
                     "barrio_dist", "ideol_dist"), data = homoL_2014, 
                   g="case", strict=T)
show_html(hom_2014)
```

Esta tabla es la misma de Smith et al. (2014). Describe la media de la distancia sociodemogrpafica por parámetro. Como alternativa, el valor TRUE del argumento `strict` de la función `egltable`, muestra los porcentajes por categoría de la variable dummy.


# ELSOC 2017
```{r}
load("C:/Users/rober/Desktop/ELSOC/ELSOC_W02_v3.00_R.RData")
load("C:/Users/rober/Desktop/ELSOC/ELSOC_W01_v4.01_R.RData")
load("C:/Users/rober/Desktop/ELSOC/ELSOC_W04_v2.01_R.RData")
```

## Subset educ madre y padre
```{r}
elsoc_2016<-elsoc_2016%>%
  dplyr::select(idencuesta,m27,m28)
elsoc_2017<-left_join(elsoc_2017,elsoc_2016,by="idencuesta")
```

## Subset variables de género
```{r}
elsoc_2019<-elsoc_2019%>%
  dplyr::select(idencuesta,g01_01,g01_02,g01_03,g01_04,g01_05,g02_05)
elsoc_2017<-left_join(elsoc_2017, elsoc_2019, by="idencuesta")
```

## Seleccionamos variables 
```{r}
el<-elsoc_2017 %>%
  dplyr::select(idencuesta,
                m0_sexo,
                m0_edad,
                c15, 
                m01, 
                m27,
                m28,
                m38, 
                c15,
                t06_01,
                t06_02,
                t06_03,
                t06_04,
                t06_05,
                t06_06,
                t06_07,
                t06_08,
                g01_01,
                g01_02,
                g01_03,
                g01_04,
                g01_05,
                g02_05,
                r13_sexo_01,
                r13_sexo_02,
                r13_sexo_03,
                r13_sexo_04,
                r13_sexo_05,
                r13_edad_01,
                r13_edad_02,
                r13_edad_03,
                r13_edad_04,
                r13_edad_05,
                r13_barrio_01, 
                r13_barrio_02,
                r13_barrio_03,
                r13_barrio_04,
                r13_barrio_05,
                r13_educ_01,
                r13_educ_02,
                r13_educ_03,
                r13_educ_04,
                r13_educ_05,
                r13_relig_01, 
                r13_relig_02,
                r13_relig_03,
                r13_relig_04,
                r13_relig_05,
                r13_ideol_01,
                r13_ideol_02,
                r13_ideol_03,
                r13_ideol_04,
                r13_ideol_05,
                r13_relacion_01,
                r13_relacion_02,
                r13_relacion_03,
                r13_relacion_04,
                r13_relacion_05,
                ponderador02)
```

## tamred
```{r}

el$tamred = as.numeric(!is.na(el$r13_sexo_01)) +
as.numeric(!is.na(el$r13_sexo_02)) +
as.numeric(!is.na(el$r13_sexo_03)) +
as.numeric(!is.na(el$r13_sexo_04)) +
as.numeric(!is.na(el$r13_sexo_05))
print(prop.table(table(el$tamred)), 2)
```

## Recodificamos 
```{r}
### Ego
el$ego_p_educ<-factor(Recode(el$m27,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_m_educ<-factor(Recode(el$m28,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_educ <-factor(Recode(el$m01,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_relig<-factor(Recode(el$m38,"1=1;2=2;3:6=3;7:9=4;-999:-888=NA"))
#el$ego_ideol<-factor(Recode(el$c15,"9:10=1;6:8=2;5=3;2:4=4;0:1=5;11:12=6;-999:-888=NA"))
#el$ego_edad<-factor(Recode(el$m0_edad,"18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))
el$ego_edad <-el$m0_edad
el$ego_sexo <-factor(Recode(el$m0_sexo,"1=1;2=0"))
el$ego_barrio<-1
# Indice de calidad barrial
el<-el%>%
  na_if(-888)%>%
  na_if(-999)%>%
  mutate(cal_entorno=(t06_01+t06_02+t06_03+t06_04+
                        t06_05+t06_06+t06_07+t06_08)/8)
#summary(el$cal_entorno) #NA's=498

#indice de "Machismo suave"
el<-el%>%
  na_if(-888)%>%
  na_if(-999)%>%
  mutate(machismo=(g01_01+g01_02+g01_03+g01_04+g01_05+g02_05)/6)
#summary(el$machismo) #NA's= 857

### Alter's
el$alter_educ1 <-factor(Recode(el$r13_educ_01,"1=1;2:3=2;4=3;5=4;-999=NA"))
el$alter_educ2 <-factor(Recode(el$r13_educ_02,"1=1;2:3=2;4=3;5=4;-999=NA"))
el$alter_educ3 <-factor(Recode(el$r13_educ_03,"1=1;2:3=2;4=3;5=4;-999=NA"))
el$alter_educ4 <-factor(Recode(el$r13_educ_04,"1=1;2:3=2;4=3;5=4;-999=NA"))
el$alter_educ5 <-factor(Recode(el$r13_educ_05,"1=1;2:3=2;4=3;5=4;-999=NA"))

el$alter_relig1<-factor(Recode(el$r13_relig_01,"1=1;2=2;3:4=4;5=3;-999=NA"))
el$alter_relig2<-factor(Recode(el$r13_relig_02,"1=1;2=2;3:4=4;5=3;-999=NA"))
el$alter_relig3<-factor(Recode(el$r13_relig_03,"1=1;2=2;3:4=4;5=3;-999=NA"))
el$alter_relig4<-factor(Recode(el$r13_relig_04,"1=1;2=2;3:4=4;5=3;-999=NA"))
el$alter_relig5<-factor(Recode(el$r13_relig_05,"1=1;2=2;3:4=4;5=3;-999=NA"))

#el$alter_edad1 <-factor(Recode(el$r13_edad_01,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))
#el$alter_edad2 <-factor(Recode(el$r13_edad_02,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))
#el$alter_edad3 <-factor(Recode(el$r13_edad_03,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))
#el$alter_edad4 <-factor(Recode(el$r13_edad_04,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))
#el$alter_edad5 <-factor(Recode(el$r13_edad_05,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6"))

el$alter_edad1<-el$r13_edad_01
el$alter_edad2<-el$r13_edad_02
el$alter_edad3<-el$r13_edad_03
el$alter_edad4<-el$r13_edad_04
el$alter_edad5<-el$r13_edad_05
#summary(el$alter_edad1)

el$alter_sexo1<-factor(Recode(el$r13_sexo_01,"1=1;2=0"))
el$alter_sexo2<-factor(Recode(el$r13_sexo_02,"1=1;2=0"))
el$alter_sexo3<-factor(Recode(el$r13_sexo_03,"1=1;2=0"))
el$alter_sexo4<-factor(Recode(el$r13_sexo_04,"1=1;2=0"))
el$alter_sexo5<-factor(Recode(el$r13_sexo_05,"1=1;2=0"))

el$alter_barrio1<-Recode(el$r13_barrio_01,"1=1;2=0")
el$alter_barrio2<-Recode(el$r13_barrio_02,"1=1;2=0")
el$alter_barrio3<-Recode(el$r13_barrio_03,"1=1;2=0")
el$alter_barrio4<-Recode(el$r13_barrio_04,"1=1;2=0")
el$alter_barrio5<-Recode(el$r13_barrio_05,"1=1;2=0")


## ideología 
table(el$c15) #ideol
el$c15[el$c15 == 0 | el$c15 == 1 | el$c15 == 2]<- 'leftwinger'
el$c15[el$c15 == 3 | el$c15 == 4] <- 'center-left' 
el$c15[el$c15 == 5]  <- 'center'
el$c15[el$c15 == 11 | el$c15 == 12] <- 'none'
el$c15[el$c15 == 6 | el$c15 == 7]<- 'center-right'
el$c15[el$c15 == 8 | el$c15 == 9 | el$c15 == 10] <- 'rihtwinger'

el$ego_ideol<-el$c15
el$ego_ideol[el$ego_ideol==-999] <- NA
el$ego_ideol[el$ego_ideol==-888] <- NA
table(el$ego_ideol)

## ideol alter, derecha, centro derecha, centro, centro izquierda, izquierda, ninguno (6)
table(el$r13_ideol_03) #

for (i in 1:5){
  eval(parse(text=paste('el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==1 & !is.na(el$r13_ideol_0',i,')]<-\'rightwinger\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==2 & !is.na(el$r13_ideol_0',i,')]<-\'center-right\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==3 & !is.na(el$r13_ideol_0',i,')]<-\'center\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==6 & !is.na(el$r13_ideol_0',i,')]<-\'none\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==4 & !is.na(el$r13_ideol_0',i,')]<-\'center-left\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==5 & !is.na(el$r13_ideol_0',i,')]<-\'leftwinger\' ', sep='')))
}

el$alter_ideol1<-el$r13_ideol_01
el$alter_ideol1[el$alter_ideol1==-999] <- NA
el$alter_ideol1[el$alter_ideol1==-888] <- NA

el$alter_ideol2<-el$r13_ideol_02
el$alter_ideol2[el$alter_ideol2==-999] <- NA
el$alter_ideol2[el$alter_ideol2==-888] <- NA

el$alter_ideol3<-el$r13_ideol_03
el$alter_ideol3[el$alter_ideol3==-999] <- NA
el$alter_ideol3[el$alter_ideol3==-888] <- NA

el$alter_ideol4<-el$r13_ideol_04
el$alter_ideol4[el$alter_ideol4==-999] <- NA
el$alter_ideol4[el$alter_ideol4==-888] <- NA

el$alter_ideol5<-el$r13_ideol_05
el$alter_ideol5[el$alter_ideol5==-999] <- NA
el$alter_ideol5[el$alter_ideol5==-888] <- NA

table(el$alter_ideol2)

# relación
el<-el%>%
  dplyr::mutate(alter_relacion1=case_when(r13_relacion_01%in%1:3~"fam",
                                          r13_relacion_01%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion2=case_when(r13_relacion_02%in%1:3~"fam",
                                          r13_relacion_02%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion3=case_when(r13_relacion_03%in%1:3~"fam",
                                          r13_relacion_03%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion4=case_when(r13_relacion_04%in%1:3~"fam",
                                          r13_relacion_04%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion5=case_when(r13_relacion_05%in%1:3~"fam",
                                          r13_relacion_05%in%4:5~"nofam"))

# crear variable proporción del total de vecinos
el<-el %>% 
  na_if(-999)%>%
  rowwise() %>% 
  mutate(barrio_total = sum(alter_barrio1,alter_barrio2,alter_barrio3,
                   alter_barrio4,alter_barrio5, na.rm=TRUE))%>%
  mutate(barrio_prop = barrio_total/tamred)

summary(el$barrio_prop)
mean(el$barrio_prop, na.rm=TRUE)
table(el$barrio_total, el$tamred)
#[1] 0.5675903
```

## Subset cross
```{r}
homoC_2017<-el%>%
  dplyr::select(idencuesta,ego_sexo, ego_edad, ego_educ, ego_relig, ego_barrio,
                ego_ideol,tamred,alter_sexo1, alter_sexo2, alter_sexo3, alter_sexo4,
                alter_sexo5, alter_edad1, alter_edad2, alter_edad3, alter_edad4,
                alter_edad5, alter_relig1, alter_relig2, alter_relig3, alter_relig4,
                alter_relig5, alter_educ1, alter_educ2, alter_educ3, alter_educ4,
                alter_educ5, alter_barrio1, alter_barrio2, alter_barrio3, alter_barrio4,
                alter_barrio5, alter_ideol1, alter_ideol2, alter_ideol3, alter_ideol4,
                alter_ideol5, alter_relacion1,alter_relacion2,alter_relacion3, 
                alter_relacion4, alter_relacion5,ponderador=ponderador02,
                ego_p_educ, ego_m_educ, machismo, cal_entorno)

homoC_2017$año<-2017
```


## Distancias observadas (missmatch)
```{r}
##NOTA: weights are problematic: seleccionan misma persona con mucha mayor frecuencia.
d <- length(el$idencuesta)
table(table(sample(el$idencuesta, d, replace=T, prob = (1/el$ponderador02))))
table(table(sample(el$idencuesta, d, replace=T)))
#Si se usa ponderador, usar de la ola 1, no 2 (este tiene NA's)

#Distancia Social Observada entre Ego-Alter
vars_to_keep <- c("idencuesta", "ego_educ", "ego_relig",
                  "ego_ideol", "ego_edad", "ego_sexo",
                  "alter_educ1", "alter_educ2", "alter_educ3",
                  "alter_educ4", "alter_educ5", "alter_relig1",
                  "alter_relig2", "alter_relig3", "alter_relig4",
                  "alter_relig5", "alter_ideol1", "alter_ideol2", 
                  "alter_ideol3", "alter_ideol4", "alter_ideol5",
                  "alter_edad1", "alter_edad2", "alter_edad3",
                  "alter_edad4", "alter_edad5", "alter_sexo1", 
                  "alter_sexo2", "alter_sexo3", "alter_sexo4", 
                  "alter_sexo5", "alter_barrio1", "alter_barrio2",
                  "alter_barrio3", "alter_barrio4", "alter_barrio5")

elsoc_egos <- el[names(el) %in% vars_to_keep]

educa_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
edad_obs_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
relig_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
sexo_obs_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
barrio_obs_dist<- array(NA, dim=list(nrow(elsoc_egos), 5))
ideol_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))


### Distancia ego-alter observados

#Distancia educativa
for(k in 1:5) educa_obs_dist[,k] <- ifelse(
  el$ego_educ == eval(parse(text=paste0("el$alter_educ", k))), 1, 0)
educa_obs_dist <- data.frame(educa_obs_dist)
names(educa_obs_dist) <- paste0("educ_dist_",1:5)

## Edad
for(k in 1:5) edad_obs_dist[,k] <- ifelse(
  ((el$ego_edad) - eval(parse(text=paste0("el$alter_edad", k))))<=5, 1, 0)
edad_obs_dist <- data.frame(edad_obs_dist)
names(edad_obs_dist) <- paste0("edad_dist_",1:5)

## Religion
for(k in 1:5) relig_obs_dist[,k] <- ifelse(
  el$ego_relig == eval(parse(text=paste0("el$alter_relig", k))), 1, 0)
relig_obs_dist <- data.frame(relig_obs_dist)
names(relig_obs_dist) <- paste0("relig_dist_",1:5)

## Sexo
for(k in 1:5) sexo_obs_dist[,k] <- ifelse(
  el$ego_sexo == eval(parse(text=paste0("el$alter_sexo", k))), 1, 0)
sexo_obs_dist <- data.frame(sexo_obs_dist)
names(sexo_obs_dist) <- paste0("sexo_dist_",1:5)

## Barrio
for(k in 1:5) barrio_obs_dist[,k] <- ifelse(
  el$ego_barrio == eval(parse(text=paste0("el$alter_barrio", k))), 1, 0)
barrio_obs_dist <- data.frame(barrio_obs_dist)
names(barrio_obs_dist) <- paste0("barrio_dist_",1:5)

## Ideología
for(k in 1:5) ideol_obs_dist[,k] <- ifelse(
  el$ego_ideol == eval(parse(text=paste0("el$alter_ideol", k))), 1, 0)
ideol_obs_dist <- data.frame(ideol_obs_dist)
names(ideol_obs_dist) <- paste0("ideol_dist_",1:5)

hom_obs <- data.frame(cbind(elsoc_egos, educa_obs_dist, edad_obs_dist, 
                            relig_obs_dist, sexo_obs_dist,barrio_obs_dist,
                            ideol_obs_dist))

hom_obs$case <- 1
```

```{r}
hom_obs<-hom_obs%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4,
                barrio_dist_5,ideol_dist_1,ideol_dist_2,ideol_dist_3,ideol_dist_4,
                ideol_dist_5)

head(hom_obs)
```


## Simulación (controles)
```{r}
## Preparativos simulacion de alteres
sexo_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
edad_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
educ_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
relig_sim_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
barrio_sim_dist<- array(NA, dim=list(nrow(elsoc_egos), 5))
ideol_sim_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))

```

### Weight en base a CASEN
```{r}
w_casen <- read.csv("C:/Users/rober/Desktop/homofilia_elsoc/weight_casen.csv", sep=";")
```

### Simulación con parámetros
```{r}
set.seed(44322)
n <- 50
d <- length(elsoc_egos$idencuesta)
```

### Post-stratificaction weight
```{r}
age_recode <- "18:30=18; 31:45=31; 46:60=46; else=61"
elsoc_egos$age_grp <- car::recode(elsoc_egos$ego_edad, age_recode)
elsoc_egos$educ_grp <- elsoc_egos$ego_educ
educ_recode<- "1=2;2=3;3=4;else=5"
elsoc_egos$educ_grp <- car::recode(elsoc_egos$ego_educ, educ_recode)
elsoc_egos$educ_grp <- factor(elsoc_egos$educ_grp, exclude=NULL)


w <- data.frame(xtabs(~educ_grp + ego_sexo + age_grp, data=elsoc_egos))
#names(w) <- c("educaR_w02", "m0_sexo_w02", "Freq")
w$prop <- w$Freq / sum(w$Freq)
w$prop_target <- w_casen[,4]
w$N_target <- w$prop_target*sum(w$Freq)
w$w <- w$N_target/w$Freq
w$ego_sexo <- as.numeric(levels(w$ego_sexo))[w$ego_sexo]

el <- merge(elsoc_egos, w, by=c("educ_grp", "ego_sexo", "age_grp"))
```

### Sample random alters from observed egos
```{r}
#NOTA: Usar 'join' en lugar de 'merge', ya que este ultimo ordena las filas segun
#'idencuesta', y por ende altera la seleccion aleatoria de alteres.
nonties1 <- data.frame(idencuesta = sample(el$idencuesta, d, replace=T, el$w))
nonties1 <- plyr::join(nonties1, elsoc_egos, by="idencuesta")

nonties2 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties2 <- plyr::join(nonties2, elsoc_egos, by="idencuesta")

nonties3 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties3 <- plyr::join(nonties3, elsoc_egos, by="idencuesta")

nonties4 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties4 <- plyr::join(nonties4, elsoc_egos, by="idencuesta")

nonties5 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties5 <- plyr::join(nonties5, elsoc_egos, by="idencuesta")

  #Delete variables for next loop
    elsoc_egos$Freq <- NULL
    elsoc_egos$prop <- NULL
    elsoc_egos$prop_target <- NULL
    elsoc_egos$N_target <- NULL
    elsoc_egos$w <- NULL
    elsoc_egos$age_grp <- NULL
    elsoc_egos$educ_grp <- NULL
    
### Distancia ego-alter simuladaos
    
## Educ
for(k in 1:5) educ_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_educ == eval(parse(text=paste0("nonties",k,"$ego_educ"))), 1, 0)
    educ_sim_dist <- data.frame(educ_sim_dist)
    names(educ_sim_dist) <- paste0("educ_dist_",1:5)
    
## Edad
for(k in 1:5) edad_sim_dist[,k] <- ifelse(
    ((elsoc_egos$ego_edad) - eval(parse(text=paste0("nonties",k,"$ego_edad"))))<=5, 1, 0)
    edad_sim_dist <- data.frame(edad_sim_dist)
    names(edad_sim_dist) <- paste0("edad_dist_",1:5)

## Religion
for(k in 1:5) relig_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_relig == eval(parse(text=paste0("nonties",k,"$ego_relig"))), 1, 0)
    relig_sim_dist <- data.frame(relig_sim_dist)
    names(relig_sim_dist) <- paste0("relig_dist_",1:5)
    
## Sexo
for(k in 1:5) sexo_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_sexo == eval(parse(text=paste0("nonties",k,"$ego_sexo"))), 1, 0)
    sexo_sim_dist <- data.frame(sexo_sim_dist)
    names(sexo_sim_dist) <- paste0("sexo_dist_",1:5)
    
## Barrio
#barrio_sim_dist<-apply(barrio_sim_dist, c(1,2), function(x) sample(c(0,1),1))
barrio_sim_dist <- matrix(rbinom(2473*5,1,0.6),2473,5) # Criterio minimalista
barrio_sim_dist <- data.frame(barrio_sim_dist)
names(barrio_sim_dist) <- paste0("barrio_dist_",1:5)

## Ideología
for(k in 1:5) ideol_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_ideol == eval(parse(text=paste0("nonties",k,"$ego_ideol"))), 1, 0)
    ideol_sim_dist <- data.frame(ideol_sim_dist)
    names(ideol_sim_dist) <- paste0("ideol_dist_",1:5)
    
hom_sim <- data.frame(cbind(el, educ_sim_dist, edad_sim_dist, relig_sim_dist, 
                            sexo_sim_dist, barrio_sim_dist, ideol_sim_dist))
hom_sim$case <- 0
```

```{r}
hom_sim<-hom_sim%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4, 
                barrio_dist_5, ideol_dist_1, ideol_dist_2, ideol_dist_3, 
                ideol_dist_4, ideol_dist_5)

head(hom_sim)
```

### Eliminar alteres simulados si info de alter no fue observada
```{r}
vwm <- names(hom_sim)[!names(hom_sim) %in% c("idencuesta","case")]
for(l in 1:length(vwm)) hom_sim[vwm[l]][is.na(hom_obs[vwm[l]])]<- NA
head(hom_sim)
```

### Merge & reshape 
```{r}
#Merge
homo <- plyr::rbind.fill(hom_obs, hom_sim)

#Reshape Data 
homoL <- reshape(homo, varying = list(paste0("educ_dist_", 1:5),
                                      paste0("edad_dist_", 1:5),
                                      paste0("relig_dist_", 1:5),
                                      paste0("sexo_dist_", 1:5),
                                      paste0("barrio_dist_", 1:5),
                                      paste0("ideol_dist_", 1:5)),
                 v.names=c("educ_dist", "edad_dist", "relig_dist", "sexo_dist",
                           "barrio_dist", "ideol_dist"), 
                 direction="long")

homoL<-arrange(homoL, idencuesta)
rownames(homoL) <- NULL

homoL_2017 <- homoL[order(homoL$idencuesta),]
homoL_2017$año<-2017
#Drop lots of NA's - though with or without N of regresion is equal.
#homoL <- subset(homoL, !is.na(sexo_dist))
#head(homoL, 20)
```


# Descriptivos 

## Sexo (observada y simulada)
```{r}

meanFunc <- function(x,i){mean(x[i])}

sexo_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

sexo_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

boot_sexo_o<-boot(sexo_dist_b_o$sexo_dist, meanFunc, 1000)
boot_sexo_o
mean<-0.64
SE<-0.006
dist_obs_sexo_des<-c(mean,SE)
dist_obs_sexo_des

boot_sexo_s<-boot(sexo_dist_b_s$sexo_dist, meanFunc, 1000)
boot_sexo_s
mean<-0.5
SE<-0.006
dist_sim_sexo_des<-c(mean,SE)
dist_sim_sexo_des


dist_sexo_abs_2017<-rbind(dist_obs_sexo_des,dist_sim_sexo_des)
dist_sexo_abs_2017
```


## edad (observada y simulada)
```{r}
edad_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

edad_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

boot_edad_o<-boot(edad_dist_b_o$edad_dist, meanFunc, 1000)
boot_edad_o
mean<-0.61
SE<-0.006
dist_obs_edad_des<-c(mean,SE)
dist_obs_edad_des

boot_edad_s<-boot(edad_dist_b_s$edad_dist, meanFunc, 1000)
boot_edad_s
mean<-0.55
SE<-0.006
dist_sim_edad_des<-c(mean,SE)
dist_sim_edad_des


dist_edad_abs_2017<-rbind(dist_obs_edad_des,dist_sim_edad_des)
dist_edad_abs_2017
```

## educ (observada y simulada)
```{r}
educ_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

educ_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

boot_educ_o<-boot(educ_dist_b_o$educ_dist, meanFunc, 1000)
boot_educ_o
mean<-0.48
SE<-0.006
dist_obs_educ_des<-c(mean,SE)
dist_obs_educ_des

boot_educ_s<-boot(educ_dist_b_s$educ_dist, meanFunc, 1000)
boot_educ_s
mean<-0.27
SE<-0.005
dist_sim_educ_des<-c(mean,SE)
dist_sim_educ_des


dist_educ_abs_2017<-rbind(dist_obs_educ_des,dist_sim_educ_des)
dist_educ_abs_2017
```

## relig (observada y simulada)
```{r}
relig_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

relig_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

boot_relig_o<-boot(relig_dist_b_o$relig_dist, meanFunc, 1000)
boot_relig_o
mean<-0.63
SE<-0.006
dist_obs_relig_des<-c(mean,SE)
dist_obs_relig_des

boot_relig_s<-boot(relig_dist_b_s$relig_dist, meanFunc, 1000)
boot_relig_s
mean<-0.37
SE<-0.005
dist_sim_relig_des<-c(mean,SE)
dist_sim_relig_des

dist_relig_abs_2017<-rbind(dist_obs_relig_des,dist_sim_relig_des)
dist_relig_abs_2017
```

## barrio (observada y simulada)
```{r}
barrio_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

barrio_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

boot_barrio_o<-boot(barrio_dist_b_o$barrio_dist, meanFunc, 1000)
boot_barrio_o
mean<-0.52
SE<-0.006
dist_obs_barrio_des<-c(mean,SE)
dist_obs_barrio_des

boot_barrio_s<-boot(barrio_dist_b_s$barrio_dist, meanFunc, 1000)
boot_barrio_s
mean<-0.60
SE<-0.006
dist_sim_barrio_des<-c(mean,SE)
dist_sim_barrio_des


dist_barrio_abs_2017<-rbind(dist_obs_barrio_des,dist_sim_barrio_des)
dist_barrio_abs_2017
```

## ideología (observada y simulada)
```{r}
ideol_dist_b_s<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

ideol_dist_b_o<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

boot_dist_o<-boot(ideol_dist_b_o$ideol_dist, meanFunc, 1000)
boot_ideol_o
mean<-0.37
SE<-0.006
dist_obs_ideol_des<-c(mean,SE)
dist_obs_ideol_des

boot_ideol_s<-boot(ideol_dist_b_s$ideol_dist, meanFunc, 1000)
boot_ideol_s
mean<-0.25
SE<-0.005
dist_sim_ideol_des<-c(mean,SE)
dist_sim_ideol_des


dist_ideol_abs_2017<-rbind(dist_obs_ideol_des,dist_sim_ideol_des)
dist_ideol_abs_2017
```

```{r}
hom_abs_2017<-rbind(  dist_sexo_abs_2017,
                      dist_educ_abs_2017,
                      dist_edad_abs_2017,
                     dist_relig_abs_2017,
                     dist_ideol_abs_2017,
                    dist_barrio_abs_2017)

hom_abs_2017<-as.data.frame(hom_abs_2017)
colnames(hom_abs_2017)<-c("Mean", "SE")
```


## Test por grupo caso/control
```{r,results='asis',message=FALSE}
hom_2017<-egltable(c("sexo_dist", "edad_dist", "educ_dist", "relig_dist", "barrio_dist",
                     "ideol_dist"), data = homoL_2017, g="case", strict=T)
show_html(hom_2017)
```

Esta tabla es la misma de Smith et al. (2014). Describe la media de la distancia sociodemogrpafica por parámetro. Como alternativa, el valor TRUE del argumento `strict` de la función `egltable`, muestra los porcentajes por categoría de la variable dummy.


# ELSOC 2019

```{r}
load("C:/Users/rober/Desktop/ELSOC/ELSOC_W04_v2.01_R.RData")
elsoc_2019<-left_join(elsoc_2019,elsoc_2016,by="idencuesta")
```

## Seleccionamos variables 
```{r}
el<-elsoc_2019 %>%
  dplyr::select(idencuesta,
                m0_sexo,
                m0_edad,
                c15, 
                m01,
                m27,
                m28,
                m38, 
                c15,
                t06_01,
                t06_02,
                t06_03,
                t06_04,
                t06_05,
                t06_06,
                t06_07,
                t06_08,
                g01_01,
                g01_02,
                g01_03,
                g01_04,
                g01_05,
                g02_05,
                c15,
                r13_sexo_01,
                r13_sexo_02,
                r13_sexo_03,
                r13_sexo_04,
                r13_sexo_05,
                r13_edad_01,
                r13_edad_02,
                r13_edad_03,
                r13_edad_04,
                r13_edad_05,
                r13_barrio_01, 
                r13_barrio_02,
                r13_barrio_03,
                r13_barrio_04,
                r13_barrio_05,
                r13_educ_01,
                r13_educ_02,
                r13_educ_03,
                r13_educ_04,
                r13_educ_05,
                r13_relig_01, 
                r13_relig_02,
                r13_relig_03,
                r13_relig_04,
                r13_relig_05,
                r13_ideol_01,
                r13_ideol_02,
                r13_ideol_03,
                r13_ideol_04,
                r13_ideol_05,
                r13_relacion_01,
                r13_relacion_02,
                r13_relacion_03,
                r13_relacion_04,
                r13_relacion_05,
                ponderador02)
```

## tamred
```{r}

el$tamred = as.numeric(!is.na(el$r13_sexo_01)) +
as.numeric(!is.na(el$r13_sexo_02)) +
as.numeric(!is.na(el$r13_sexo_03)) +
as.numeric(!is.na(el$r13_sexo_04)) +
as.numeric(!is.na(el$r13_sexo_05))
print(prop.table(table(el$tamred)), 2)
```

## Recodificamos 
```{r}
### Ego
el$ego_p_educ<-factor(Recode(el$m27,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_m_educ<-factor(Recode(el$m28,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_educ <-factor(Recode(el$m01,"1:3=1;4:5=2;6:7=3;8:10=4;-999:-888=NA"))
el$ego_relig<-factor(Recode(el$m38,"1=1;2=2;3:6=3;7:9=4;-999:-888=NA"))
table(el$ego_relig)
#el$ego_ideol<-factor(Recode(el$c15,"9:10=1;6:8=2;5=3;2:4=4;0:1=5;11:12=6;-999:-888=NA"))
#el$ego_edad <-factor(Recode(el$m0_edad,"19=1;20:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))
el$ego_edad<-el$m0_edad
el$ego_barrio<-1
el$ego_sexo <-factor(Recode(el$m0_sexo,"1=1;2=0;-999:-888=NA"))

# Indice de calidad barrial
el<-el%>%
  na_if(-888)%>%
  na_if(-999)%>%
  mutate(cal_entorno=(t06_01+t06_02+t06_03+t06_04+
                        t06_05+t06_06+t06_07+t06_08)/8)
#summary(el$cal_entorno) #NA's=498

#indice de "Machismo suave"
el<-el%>%
  na_if(-888)%>%
  na_if(-999)%>%
  mutate(machismo=(g01_01+g01_02+g01_03+g01_04+g01_05+g02_05)/6)
#summary(el$machismo) #NA's= 857


### Alter's
el$alter_educ1 <-factor(Recode(el$r13_educ_01,"1=1;2:3=2;4=3;5=4;-999:-888=NA"))
el$alter_educ2 <-factor(Recode(el$r13_educ_02,"1=1;2:3=2;4=3;5=4;-999:-888=NA"))
el$alter_educ3 <-factor(Recode(el$r13_educ_03,"1=1;2:3=2;4=3;5=4;-999:-888=NA"))
el$alter_educ4 <-factor(Recode(el$r13_educ_04,"1=1;2:3=2;4=3;5=4;-999:-888=NA"))
el$alter_educ5 <-factor(Recode(el$r13_educ_05,"1=1;2:3=2;4=3;5=4;-999:-888=NA"))

el$alter_relig1<-factor(Recode(el$r13_relig_01,"1=1;2=2;3:4=4;5=3;-999:-888=NA"))
el$alter_relig2<-factor(Recode(el$r13_relig_02,"1=1;2=2;3:4=4;5=3;-999:-888=NA"))
el$alter_relig3<-factor(Recode(el$r13_relig_03,"1=1;2=2;3:4=4;5=3;-999:-888=NA"))
el$alter_relig4<-factor(Recode(el$r13_relig_04,"1=1;2=2;3:4=4;5=3;-999:-888=NA"))
el$alter_relig5<-factor(Recode(el$r13_relig_05,"1=1;2=2;3:4=4;5=3;-999:-888=NA"))

#el$alter_edad1 <-factor(Recode(el$r13_edad_01,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))
#el$alter_edad2 <-factor(Recode(el$r13_edad_02,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))
#el$alter_edad3 <-factor(Recode(el$r13_edad_03,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))
#el$alter_edad4 <-factor(Recode(el$r13_edad_04,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))
#el$alter_edad5 <-factor(Recode(el$r13_edad_05,"0:18=1;19:29=2;30:40=3;41:51=4;52:62=5;63:100=6;-999:-888=NA"))

el$alter_edad1<-el$r13_edad_01
el$alter_edad2<-el$r13_edad_02
el$alter_edad3<-el$r13_edad_03
el$alter_edad4<-el$r13_edad_04
el$alter_edad5<-el$r13_edad_05

el$alter_sexo1 <-factor(Recode(el$r13_sexo_01,"1=1;2=0;-999:-888=NA"))
el$alter_sexo2 <-factor(Recode(el$r13_sexo_02,"1=1;2=0;-999:-888=NA"))
el$alter_sexo3 <-factor(Recode(el$r13_sexo_03,"1=1;2=0;-999:-888=NA"))
el$alter_sexo4 <-factor(Recode(el$r13_sexo_04,"1=1;2=0;-999:-888=NA"))
el$alter_sexo5 <-factor(Recode(el$r13_sexo_05,"1=1;2=0;-999:-888=NA"))

el$alter_barrio1<-Recode(el$r13_barrio_01,"1=1;2=0;-999:-888=NA")
el$alter_barrio2<-Recode(el$r13_barrio_02,"1=1;2=0;-999:-888=NA")
el$alter_barrio3<-Recode(el$r13_barrio_03,"1=1;2=0;-999:-888=NA")
el$alter_barrio4<-Recode(el$r13_barrio_04,"1=1;2=0;-999:-888=NA")
el$alter_barrio5<-Recode(el$r13_barrio_05,"1=1;2=0;-999:-888=NA")

## Ideología 

table(el$c15) #ideol

el$c15[el$c15 == 0 | el$c15 == 1 | el$c15 == 2]<- 'leftwinger'
el$c15[el$c15 == 3 | el$c15 == 4] <- 'center-left' 
el$c15[el$c15 == 5]  <- 'center'
el$c15[el$c15 == 11 | el$c15 == 12] <- 'none'
el$c15[el$c15 == 6 | el$c15 == 7]<- 'center-right'
el$c15[el$c15 == 8 | el$c15 == 9 | el$c15 == 10] <- 'rightwinger'

el$ego_ideol<-el$c15
table(el$ego_ideol)

## ideol alter, derecha, centro derecha, centro, centro izquierda, izquierda, ninguno (6)
table(el$r13_ideol_03) #

for (i in 1:5){
  eval(parse(text=paste('el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==1 & !is.na(el$r13_ideol_0',i,')]<-\'rightwinger\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==2 & !is.na(el$r13_ideol_0',i,')]<-\'center-right\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==3 & !is.na(el$r13_ideol_0',i,')]<-\'center\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==6 & !is.na(el$r13_ideol_0',i,')]<-\'none\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==4 & !is.na(el$r13_ideol_0',i,')]<-\'center-left\' ;',
                        'el$r13_ideol_0',i,'[el$r13_ideol_0',i,'==5 & !is.na(el$r13_ideol_0',i,')]<-\'leftwinger\' ', sep='')))
}

el$alter_ideol1<-el$r13_ideol_01
el$alter_ideol1[el$alter_ideol1==-999] <- NA
el$alter_ideol1[el$alter_ideol1==-888] <- NA

el$alter_ideol2<-el$r13_ideol_02
el$alter_ideol2[el$alter_ideol2==-999] <- NA
el$alter_ideol2[el$alter_ideol2==-888] <- NA

el$alter_ideol3<-el$r13_ideol_03
el$alter_ideol3[el$alter_ideol3==-999] <- NA
el$alter_ideol3[el$alter_ideol3==-888] <- NA

el$alter_ideol4<-el$r13_ideol_04
el$alter_ideol4[el$alter_ideol4==-999] <- NA
el$alter_ideol4[el$alter_ideol4==-888] <- NA

el$alter_ideol5<-el$r13_ideol_05
el$alter_ideol5[el$alter_ideol5==-999] <- NA
el$alter_ideol5[el$alter_ideol5==-888] <- NA

table(el$alter_ideol2)

## relación alter
el<-el%>%
  dplyr::mutate(alter_relacion1=case_when(r13_relacion_01%in%1:3~"fam",
                                          r13_relacion_01%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion2=case_when(r13_relacion_02%in%1:3~"fam",
                                          r13_relacion_02%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion3=case_when(r13_relacion_03%in%1:3~"fam",
                                          r13_relacion_03%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion4=case_when(r13_relacion_04%in%1:3~"fam",
                                          r13_relacion_04%in%4:5~"nofam"))%>%
  dplyr::mutate(alter_relacion5=case_when(r13_relacion_05%in%1:3~"fam",
                                          r13_relacion_05%in%4:5~"nofam"))
# tamaño de la red
el$tamred = as.numeric(!is.na(el$alter_sexo1)) +
            as.numeric(!is.na(el$alter_sexo2)) +
            as.numeric(!is.na(el$alter_sexo3)) +
            as.numeric(!is.na(el$alter_sexo4)) +
            as.numeric(!is.na(el$alter_sexo5))
print(prop.table(table(el$tamred)), 2)

# crear variable proporción del total de vecinos
el<-el %>% 
  rowwise() %>% 
  mutate(barrio_total = sum(alter_barrio1,alter_barrio2,alter_barrio3,
                   alter_barrio4,alter_barrio5, na.rm=TRUE))%>%
  mutate(barrio_prop = barrio_total/tamred)

is.na(el$barrio_prop) <- sapply(el$barrio_prop, is.infinite) #definir inf
table(el$barrio_prop)
summary(el$barrio_prop)

mean(el$barrio_prop, na.rm=TRUE)

table(el$barrio_total, el$tamred)
#[1] 0.3376929
```

## Subset cross
```{r}
homoC_2019<-el%>%
  dplyr::select(idencuesta,ego_sexo, ego_edad, ego_educ, ego_relig, ego_barrio,
                ego_ideol,tamred,alter_sexo1, alter_sexo2, alter_sexo3, alter_sexo4,
                alter_sexo5, alter_edad1, alter_edad2, alter_edad3, alter_edad4,
                alter_edad5, alter_relig1, alter_relig2, alter_relig3, alter_relig4,
                alter_relig5, alter_educ1, alter_educ2, alter_educ3, alter_educ4,
                alter_educ5, alter_barrio1, alter_barrio2, alter_barrio3, alter_barrio4,
                alter_barrio5, alter_ideol1, alter_ideol2, alter_ideol3, alter_ideol4,
                alter_ideol5, alter_relacion1,alter_relacion2,alter_relacion3, 
                alter_relacion4, alter_relacion5,ponderador=ponderador02,
                ego_p_educ, ego_m_educ, machismo, cal_entorno)

homoC_2019$año<-2019
```

## Distancias observadas (missmatch)
```{r}
##NOTA: weights are problematic: seleccionan misma persona con mucha mayor frecuencia.
d <- length(el$idencuesta)
table(table(sample(el$idencuesta, d, replace=T, prob = (1/el$ponderador02))))
table(table(sample(el$idencuesta, d, replace=T)))
#Si se usa ponderador, usar de la ola 1, no 2 (este tiene NA's)

#Distancia Social Observada entre Ego-Alter
vars_to_keep <- c("idencuesta", "ego_educ", "ego_relig",
                  "ego_ideol", "ego_edad", "ego_sexo",
                  "alter_educ1", "alter_educ2", "alter_educ3",
                  "alter_educ4", "alter_educ5", "alter_relig1",
                  "alter_relig2", "alter_relig3", "alter_relig4",
                  "alter_relig5", "alter_ideol1", "alter_ideol2", 
                  "alter_ideol3", "alter_ideol4", "alter_ideol5",
                  "alter_edad1", "alter_edad2", "alter_edad3",
                  "alter_edad4", "alter_edad5", "alter_sexo1", 
                  "alter_sexo2", "alter_sexo3", "alter_sexo4", 
                  "alter_sexo5", "alter_barrio1", "alter_barrio2",
                  "alter_barrio3", "alter_barrio4", "alter_barrio5")


elsoc_egos <- el[names(el) %in% vars_to_keep]

educa_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
edad_obs_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
relig_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
sexo_obs_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
barrio_obs_dist<- array(NA, dim=list(nrow(elsoc_egos), 5))
ideol_obs_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))

### Distancia ego-alter observados

#Distancia educativa
for(k in 1:5) educa_obs_dist[,k] <- ifelse(
  el$ego_educ == eval(parse(text=paste0("el$alter_educ", k))), 1, 0)
educa_obs_dist <- data.frame(educa_obs_dist)
names(educa_obs_dist) <- paste0("educ_dist_",1:5)

## Edad
for(k in 1:5) edad_obs_dist[,k] <- ifelse(
  ((el$ego_edad) - eval(parse(text=paste0("el$alter_edad", k))))<=5, 1, 0)
edad_obs_dist <- data.frame(edad_obs_dist)
names(edad_obs_dist) <- paste0("edad_dist_",1:5)

## Religion
for(k in 1:5) relig_obs_dist[,k] <- ifelse(
  el$ego_relig == eval(parse(text=paste0("el$alter_relig", k))), 1, 0)
relig_obs_dist <- data.frame(relig_obs_dist)
names(relig_obs_dist) <- paste0("relig_dist_",1:5)

## Sexo
for(k in 1:5) sexo_obs_dist[,k] <- ifelse(
  el$ego_sexo == eval(parse(text=paste0("el$alter_sexo", k))), 1, 0)
sexo_obs_dist <- data.frame(sexo_obs_dist)
names(sexo_obs_dist) <- paste0("sexo_dist_",1:5)

## Barrio
for(k in 1:5) barrio_obs_dist[,k] <- ifelse(
  el$ego_barrio == eval(parse(text=paste0("el$alter_barrio", k))), 1, 0)
barrio_obs_dist <- data.frame(barrio_obs_dist)
names(barrio_obs_dist) <- paste0("barrio_dist_",1:5)

## Ideología
for(k in 1:5) ideol_obs_dist[,k] <- ifelse(
  el$ego_ideol == eval(parse(text=paste0("el$alter_ideol", k))), 1, 0)
ideol_obs_dist <- data.frame(ideol_obs_dist)
names(ideol_obs_dist) <- paste0("ideol_dist_",1:5)

hom_obs <- data.frame(cbind(elsoc_egos, educa_obs_dist, edad_obs_dist, 
                            relig_obs_dist, sexo_obs_dist, barrio_obs_dist,
                            ideol_obs_dist))
hom_obs$case <- 1
```

```{r}
hom_obs<-hom_obs%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4,
                barrio_dist_5, ideol_dist_1, ideol_dist_2, ideol_dist_3,
                ideol_dist_4, ideol_dist_5)

head(hom_obs)
```


## Simulación (controles)
```{r}
## Preparativos simulacion de alteres
sexo_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
edad_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
educ_sim_dist  <- array(NA, dim=list(nrow(elsoc_egos), 5))
relig_sim_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
barrio_sim_dist<- array(NA, dim=list(nrow(elsoc_egos), 5))
ideol_sim_dist <- array(NA, dim=list(nrow(elsoc_egos), 5))
```

### Weight en base a CASEN
```{r}
w_casen <- read.csv("C:/Users/rober/Desktop/homofilia_elsoc/weight_casen.csv", sep=";")
```

### Simulación con parámetros
```{r}
set.seed(44322)
n <- 50
d <- length(elsoc_egos$idencuesta)
```

### Post-stratificaction weight
```{r}
age_recode <- "18:30=18; 31:45=31; 46:60=46; else=61"
elsoc_egos$age_grp <- car::recode(elsoc_egos$ego_edad, age_recode)
elsoc_egos$educ_grp <- elsoc_egos$ego_educ
educ_recode<- "1=2;2=3;3=4;else=5"
elsoc_egos$educ_grp <- car::recode(elsoc_egos$ego_educ, educ_recode)
elsoc_egos$educ_grp <- factor(elsoc_egos$educ_grp, exclude=NULL)

w <- data.frame(xtabs(~educ_grp + ego_sexo + age_grp, data=elsoc_egos))
#names(w) <- c("educaR_w02", "m0_sexo_w02", "Freq")
w$prop <- w$Freq / sum(w$Freq)
w$prop_target <- w_casen[,4]
w$N_target <- w$prop_target*sum(w$Freq)
w$w <- w$N_target/w$Freq
w$ego_sexo <- as.numeric(levels(w$ego_sexo))[w$ego_sexo]

el <- merge(elsoc_egos, w, by=c("educ_grp", "ego_sexo", "age_grp"))
```

### Sample random alters from observed egos
```{r}
#NOTA: Usar 'join' en lugar de 'merge', ya que este ultimo ordena las filas segun
#'idencuesta', y por ende altera la seleccion aleatoria de alteres.
nonties1 <- data.frame(idencuesta = sample(el$idencuesta, d, replace=T, el$w))
nonties1 <- plyr::join(nonties1, elsoc_egos, by="idencuesta")

nonties2 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties2 <- plyr::join(nonties2, elsoc_egos, by="idencuesta")

nonties3 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties3 <- plyr::join(nonties3, elsoc_egos, by="idencuesta")

nonties4 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties4 <- plyr::join(nonties4, elsoc_egos, by="idencuesta")

nonties5 <- data.frame(idencuesta=sample(el$idencuesta, d, replace=T, el$w))
nonties5 <- plyr::join(nonties5, elsoc_egos, by="idencuesta")

  #Delete variables for next loop
    elsoc_egos$Freq <- NULL
    elsoc_egos$prop <- NULL
    elsoc_egos$prop_target <- NULL
    elsoc_egos$N_target <- NULL
    elsoc_egos$w <- NULL
    elsoc_egos$age_grp <- NULL
    elsoc_egos$educ_grp <- NULL
    
### Distancia ego-alter simuladaos
    
## Educ
for(k in 1:5) educ_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_educ == eval(parse(text=paste0("nonties",k,"$ego_educ"))), 1, 0)
    educ_sim_dist <- data.frame(educ_sim_dist)
    names(educ_sim_dist) <- paste0("educ_dist_",1:5)
    
## Edad
for(k in 1:5) edad_sim_dist[,k] <- ifelse(
    ((elsoc_egos$ego_edad) - eval(parse(text=paste0("nonties",k,"$ego_edad"))))<=5, 1, 0)
    edad_sim_dist <- data.frame(edad_sim_dist)
    names(edad_sim_dist) <- paste0("edad_dist_",1:5)
    
## Religion
for(k in 1:5) relig_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_relig == eval(parse(text=paste0("nonties",k,"$ego_relig"))), 1, 0)
    relig_sim_dist <- data.frame(relig_sim_dist)
    names(relig_sim_dist) <- paste0("relig_dist_",1:5)
    
## Sexo
for(k in 1:5) sexo_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_sexo == eval(parse(text=paste0("nonties",k,"$ego_sexo"))), 1, 0)
    sexo_sim_dist <- data.frame(sexo_sim_dist)
    names(sexo_sim_dist) <- paste0("sexo_dist_",1:5)
    
## Barrio
#barrio_sim_dist<-apply(barrio_sim_dist, c(1,2), function(x) sample(c(0,1),1))
barrio_sim_dist <- matrix(rbinom(3417*5,1,0.34),3417,5) # Criterio minimalista = media a de la proporción de alteris vecinos. 
barrio_sim_dist <- data.frame(barrio_sim_dist)
names(barrio_sim_dist) <- paste0("barrio_dist_",1:5)

## Ideología
for(k in 1:5) ideol_sim_dist[,k] <- ifelse(
    elsoc_egos$ego_ideol == eval(parse(text=paste0("nonties",k,"$ego_ideol"))), 1, 0)
    ideol_sim_dist <- data.frame(ideol_sim_dist)
    names(ideol_sim_dist) <- paste0("ideol_dist_",1:5)
    
hom_sim <- data.frame(cbind(el, educ_sim_dist, edad_sim_dist, relig_sim_dist, 
                            sexo_sim_dist, barrio_sim_dist, ideol_sim_dist))
hom_sim$case <- 0
```

```{r}
hom_sim<-hom_sim%>%
  dplyr::select(idencuesta, case, ego_sexo, ego_edad, ego_relig, ego_educ, 
                sexo_dist_1, sexo_dist_2, sexo_dist_3, sexo_dist_4, sexo_dist_5,
                edad_dist_1, edad_dist_2, edad_dist_3, edad_dist_4, edad_dist_5,
                relig_dist_1, relig_dist_2, relig_dist_3, relig_dist_4, relig_dist_5,
                educ_dist_1, educ_dist_2, educ_dist_3, educ_dist_4, educ_dist_5,
                barrio_dist_1, barrio_dist_2, barrio_dist_3, barrio_dist_4,
                barrio_dist_5, ideol_dist_1, ideol_dist_2, ideol_dist_3, 
                ideol_dist_4, ideol_dist_5)

head(hom_sim)
```

### Eliminar alteres simulados si info de alter no fue observada
```{r}
vwm <- names(hom_sim)[!names(hom_sim) %in% c("idencuesta","case")]
for(l in 1:length(vwm)) hom_sim[vwm[l]][is.na(hom_obs[vwm[l]])]<- NA
head(hom_sim)
```


### Merge & reshape 
```{r}
#Merge
homo <- plyr::rbind.fill(hom_obs, hom_sim)

#Reshape Data 
homoL <- reshape(homo, varying = list(paste0("educ_dist_", 1:5),
                                      paste0("edad_dist_", 1:5),
                                      paste0("relig_dist_", 1:5),
                                      paste0("sexo_dist_", 1:5),
                                      paste0("barrio_dist_", 1:5),
                                      paste0("ideol_dist_", 1:5)),
                 v.names=c("educ_dist", "edad_dist", "relig_dist", "sexo_dist",
                           "barrio_dist", "ideol_dist"), 
                 direction="long")

homoL<-arrange(homoL, idencuesta)
rownames(homoL) <- NULL

homoL_2019 <- homoL[order(homoL$idencuesta),]
homoL_2019$año<-2019
#homoL_2019
#Drop lots of NA's - though with or without N of regresion is equal.
#homoL <- subset(homoL, !is.na(sexo_dist))
#head(homoL, 20)
```

# Descriptivos 

## Sexo (observada y simulada)
```{r}
meanFunc <- function(x,i){mean(x[i])}

sexo_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

sexo_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(sexo_dist)%>%
  na.omit()

boot_sexo_o<-boot(sexo_dist_b_o$sexo_dist, meanFunc, 1000)
boot_sexo_o
mean<-0.65
SE<-0.005
dist_obs_sexo_des<-c(mean,SE)
dist_obs_sexo_des

boot_sexo_s<-boot(sexo_dist_b_s$sexo_dist, meanFunc, 1000)
boot_sexo_s
mean<-0.5
SE<-0.006
dist_sim_sexo_des<-c(mean,SE)
dist_sim_sexo_des

dist_sexo_abs_2019<-rbind(dist_obs_sexo_des,dist_sim_sexo_des)
dist_sexo_abs_2019
```


## edad (observada y simulada)
```{r}
edad_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

edad_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(edad_dist)%>%
  na.omit()

boot_edad_o<-boot(edad_dist_b_o$edad_dist, meanFunc, 1000)
boot_edad_o
mean<-0.64
SE<-0.005
dist_obs_edad_des<-c(mean,SE)
dist_obs_edad_des

boot_edad_s<-boot(edad_dist_b_s$edad_dist, meanFunc, 1000)
boot_edad_s
mean<-0.53
SE<-0.005
dist_sim_edad_des<-c(mean,SE)
dist_sim_edad_des

dist_edad_abs_2019<-rbind(dist_obs_edad_des,dist_sim_edad_des)
dist_edad_abs_2019
```


## educ (observada y simulada)
```{r}
educ_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

educ_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(educ_dist)%>%
  na.omit()

boot_educ_o<-boot(educ_dist_b_o$educ_dist, meanFunc, 1000)
boot_educ_o
mean<-0.50
SE<-0.006
dist_obs_educ_des<-c(mean,SE)
dist_obs_educ_des

boot_educ_s<-boot(educ_dist_b_s$educ_dist, meanFunc, 1000)
boot_educ_s
mean<-0.25
SE<-0.005
dist_sim_educ_des<-c(mean,SE)
dist_sim_educ_des

dist_educ_abs_2019<-rbind(dist_obs_educ_des,dist_sim_educ_des)
dist_educ_abs_2019
```

## relig (observada y simulada)
```{r}
relig_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

relig_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(relig_dist)%>%
  na.omit()

boot_relig_o<-boot(relig_dist_b_o$relig_dist, meanFunc, 1000)
boot_relig_o
mean<-0.65
SE<-0.005
dist_obs_relig_des<-c(mean,SE)
dist_obs_relig_des

boot_relig_s<-boot(relig_dist_b_s$relig_dist, meanFunc, 1000)
boot_relig_s
mean<-0.33
SE<-0.005
dist_sim_relig_des<-c(mean,SE)
dist_sim_relig_des

dist_relig_abs_2019<-rbind(dist_obs_relig_des,dist_sim_relig_des)
dist_relig_abs_2019
```


## barrio (observada y simulada)
```{r}
barrio_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

barrio_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(barrio_dist)%>%
  na.omit()

boot_barrio_o<-boot(barrio_dist_b_o$barrio_dist, meanFunc, 1000)
boot_barrio_o
mean<-0.49
SE<-0.007
dist_obs_barrio_des<-c(mean,SE)
dist_obs_barrio_des

boot_barrio_s<-boot(barrio_dist_b_s$barrio_dist, meanFunc, 1000)
boot_barrio_s
mean<-0.34
SE<-0.006
dist_sim_barrio_des<-c(mean,SE)
dist_sim_barrio_des

dist_barrio_abs_2019<-rbind(dist_obs_barrio_des,dist_sim_barrio_des)
dist_barrio_abs_2019
```

## barrio (observada y simulada)
```{r}
ideol_dist_b_s<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

ideol_dist_b_o<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select(ideol_dist)%>%
  na.omit()

boot_ideol_o<-boot(ideol_dist_b_o$ideol_dist, meanFunc, 1000)
boot_ideol_o
mean<-0.44
SE<-0.006
dist_obs_ideol_des<-c(mean,SE)
dist_obs_ideol_des

boot_ideol_s<-boot(ideol_dist_b_s$ideol_dist, meanFunc, 1000)
boot_ideol_s
mean<-0.23
SE<-0.005
dist_sim_ideol_des<-c(mean,SE)
dist_sim_ideol_des

dist_ideol_abs_2019<-rbind(dist_obs_ideol_des,dist_sim_ideol_des)
dist_ideol_abs_2019
```

```{r}
hom_abs_2019<-rbind(dist_sexo_abs_2019,
                    dist_educ_abs_2019,
                    dist_edad_abs_2019,
                    dist_relig_abs_2019,
                    dist_ideol_abs_2019,
                    dist_barrio_abs_2019)

hom_abs_2019<-as.data.frame(hom_abs_2019)
colnames(hom_abs_2019)<-c("Mean", "SE")
```

# Homofilia absoluta: Descriptivo gral.(ttest, Media y error estandar por bootstrap)

## ttest sexo
```{r, results='asis'}

h2014_sexo_obs<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select("sexo2014"="sexo_dist")%>%
  na.omit()

h2017_sexo_obs<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select("sexo2017"="sexo_dist")%>%
  na.omit()

h2019_sexo_obs<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select("sexo2019"="sexo_dist")%>%
  na.omit()

t.test(h2014_sexo_obs$sexo2014, h2017_sexo_obs$sexo2017, mu = ,)
t.test(h2014_sexo_obs$sexo2014, h2019_sexo_obs$sexo2019, mu = ,)


h2014_sexo_sim<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select("sexo2014"="sexo_dist")%>%
  na.omit()

h2017_sexo_sim<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select("sexo2017"="sexo_dist")%>%
  na.omit()

h2019_sexo_sim<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select("sexo2019"="sexo_dist")%>%
  na.omit()

t.test(h2014_sexo_sim$sexo2014, h2017_sexo_sim$sexo2017, mu = ,)
t.test(h2014_sexo_sim$sexo2014, h2019_sexo_sim$sexo2019, mu = ,)

```

## ttest edad
```{r}
h2014_edad_obs<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select("edad2014"="edad_dist")%>%
  na.omit()

h2017_edad_obs<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select("edad2017"="edad_dist")%>%
  na.omit()

h2019_edad_obs<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select("edad2019"="edad_dist")%>%
  na.omit()

t.test(h2014_edad_obs$edad2014, h2017_edad_obs$edad2017, mu = ,)
t.test(h2014_edad_obs$edad2014, h2019_edad_obs$edad2019, mu = ,)


h2014_educ_sim<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select("educ2014"="educ_dist")%>%
  na.omit()

h2017_educ_sim<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select("educ2017"="educ_dist")%>%
  na.omit()

h2019_educ_sim<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select("educ2019"="educ_dist")%>%
  na.omit()

t.test(h2014_educ_sim$educ2014, h2017_educ_sim$educ2017, mu = ,)
t.test(h2014_educ_sim$educ2014, h2019_educ_sim$educ2019, mu = ,)
```

## ttest educación
```{r, results='asis'}

h2014_educ_obs<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select("educ2014"="educ_dist")%>%
  na.omit()

h2017_educ_obs<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select("educ2017"="educ_dist")%>%
  na.omit()

h2019_educ_obs<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select("educ2019"="educ_dist")%>%
  na.omit()

t.test(h2014_educ_obs$educ2014, h2017_educ_obs$educ2017, mu = ,)
t.test(h2014_educ_obs$educ2014, h2019_educ_obs$educ2019, mu = ,)


h2014_edad_sim<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select("edad2014"="edad_dist")%>%
  na.omit()

h2017_edad_sim<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select("edad2017"="edad_dist")%>%
  na.omit()

h2019_edad_sim<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select("edad2019"="edad_dist")%>%
  na.omit()

t.test(h2014_edad_sim$edad2014, h2017_edad_sim$edad2017, mu = ,)
t.test(h2014_edad_sim$edad2014, h2019_edad_sim$edad2019, mu = ,)

```

## ttest religión
```{r, results='asis'}

h2014_relig_obs<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select("relig2014"="relig_dist")%>%
  na.omit()

h2017_relig_obs<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select("relig2017"="relig_dist")%>%
  na.omit()

h2019_relig_obs<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select("relig2019"="relig_dist")%>%
  na.omit()

t.test(h2014_relig_obs$relig2014, h2017_relig_obs$relig2017, mu = ,)
t.test(h2014_relig_obs$relig2014, h2019_relig_obs$relig2019, mu = ,)


h2014_relig_sim<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select("relig2014"="relig_dist")%>%
  na.omit()

h2017_relig_sim<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select("relig2017"="relig_dist")%>%
  na.omit()

h2019_relig_sim<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select("relig2019"="relig_dist")%>%
  na.omit()

t.test(h2014_relig_sim$relig2014, h2017_relig_sim$relig2017, mu = ,)
t.test(h2014_relig_sim$relig2014, h2019_relig_sim$relig2019, mu = ,)

```

## ttest barrio
```{r, results='asis'}

h2014_barrio_obs<-homoL_2014%>%
  dplyr::filter(case==1)%>%
  dplyr::select("barrio2014"="barrio_dist")%>%
  na.omit()

h2017_barrio_obs<-homoL_2017%>%
  dplyr::filter(case==1)%>%
  dplyr::select("barrio2017"="barrio_dist")%>%
  na.omit()

h2019_barrio_obs<-homoL_2019%>%
  dplyr::filter(case==1)%>%
  dplyr::select("barrio2019"="barrio_dist")%>%
  na.omit()

t.test(h2014_barrio_obs$barrio2014, h2017_barrio_obs$barrio2017, mu = ,)
t.test(h2014_barrio_obs$barrio2014, h2019_barrio_obs$barrio2019, mu = ,)


h2014_barrio_sim<-homoL_2014%>%
  dplyr::filter(case==0)%>%
  dplyr::select("barrio2014"="barrio_dist")%>%
  na.omit()

h2017_barrio_sim<-homoL_2017%>%
  dplyr::filter(case==0)%>%
  dplyr::select("barrio2017"="barrio_dist")%>%
  na.omit()

h2019_barrio_sim<-homoL_2019%>%
  dplyr::filter(case==0)%>%
  dplyr::select("barrio2019"="barrio_dist")%>%
  na.omit()

t.test(h2014_barrio_sim$barrio2014, h2017_barrio_sim$barrio2017, mu = ,)
t.test(h2014_barrio_sim$barrio2014, h2019_barrio_sim$barrio2019, mu = ,)

```

# Tabla descriptivos
```{r}
hom_abs<-cbind(hom_abs_2014,hom_abs_2017,hom_abs_2019)

hom_abs %>%
  kbl(caption = "Homofilia absoluta Chile 2014-2019") %>%
    kable_classic("hover", full_width = F)%>%
    add_header_above(c(" "= 1,"2014"=2,"2017"=2, "2019"=2))%>%
  footnote(general = "",
           alphabet = c("Los valores más cercanos a 1 indican más homofilia; ",
                      "Los errores estándar se calculan a partir de muestras bootstrap para el nivel observado de homofilia y utilizando un diseño de encuesta complejo para el nivel esperado por chance; ",
                      "Los empates Ego-Alteri para edad fueron calculados considerando un rango de diferencia de 5 años entre la edad de Ego y Alteri; ",
                      "La variable barrio no está disponible para el año 2014; "),
           general_title = "Notas: ",
           footnote_as_chunk = F,
           escape = F)
```



